<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Products | Artisan Luthier Tools</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; color: #1a1a1a; line-height: 1.6; background: #f9fafb; overflow-x: hidden; }

    /* Header & Nav */
    header { background: #ffffff; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    nav { max-width: 1280px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .logo-container { display: flex; align-items: center; gap: 12px; }
    .logo { height: 50px; width: auto; }
    .brand-text { font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 600; color: #1f2937; }
    nav ul { display: flex; list-style: none; gap: 2rem; align-items: center; }
    nav a { color: #4b5563; text-decoration: none; font-weight: 500; font-size: 0.95rem; transition: color 0.2s; }
    nav a:hover { color: #1f2937; }

    /* Cart Icon & Badge */
    .nav-cart-link { position: relative; font-size: 1.25rem; color: #1f2937; padding: 8px; transition: transform 0.2s; display: flex; align-items: center; }
    .nav-cart-link:hover { transform: scale(1.1); color: #4b5563; }
    .cart-badge {
      position: absolute; top: -2px; right: -2px; background: #dc2626; color: white;
      font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 50%; display: none;
    }

    /* Page Header */
    .page-header { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: #ffffff; padding: 60px 2rem; text-align: center; }
    .page-header h1 { font-family: 'Playfair Display', serif; font-size: 2.75rem; font-weight: 700; margin-bottom: 1rem; }
    .page-header p { font-size: 1.125rem; color: #d1d5db; max-width: 700px; margin: 0 auto; }

    /* Products Grid */
    .products-section { max-width: 1280px; margin: 0 auto; padding: 60px 2rem; }
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 2rem; margin-bottom: 60px; }
    .product-card { background: #ffffff; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; transition: all 0.3s; display: flex; flex-direction: column; }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
    .product-image { width: 100%; height: 280px; background: #f9fafb; display: flex; align-items: center; justify-content: center; padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
    .product-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .product-info { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
    .product-category { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem; }
    .product-card h3 { font-family: 'Playfair Display', serif; font-size: 1.25rem; color: #111827; margin-bottom: 0.75rem; }
    .product-card p { color: #4b5563; font-size: 0.9375rem; margin-bottom: 1.25rem; flex: 1; }
    .product-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #f3f4f6; }
    .price { font-size: 1.5rem; font-weight: 700; color: #111827; }
    .add-to-cart-btn { background: #1f2937; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .add-to-cart-btn:hover:not(:disabled) { background: #111827; transform: translateY(-1px); }
    .add-to-cart-btn:disabled { background: #9ca3af; cursor: not-allowed; }

    /* Cart Section */
    .cart-section { max-width: 800px; margin: 0 auto 60px; background: #ffffff; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .cart-list { list-style: none; margin-bottom: 1.5rem; }
    .cart-list li { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
    .cart-item-info { display: flex; align-items: center; gap: 1rem; }
    
    .remove-btn { 
      background: transparent; color: #dc2626; border: 1px solid #fee2e2; 
      padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; 
      font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .remove-btn:hover { background: #fef2f2; border-color: #f87171; }

    .clear-btn { background: #f3f4f6; color: #4b5563; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
    .cart-total { display: flex; justify-content: space-between; padding: 1.5rem 0; border-top: 2px solid #e5e7eb; font-size: 1.25rem; font-weight: 700; }
    .checkout-btn { background: #1f2937; color: white; border: none; border-radius: 8px; padding: 16px; width: 100%; font-weight: 600; cursor: pointer; font-size: 1rem; }

    /* Notification */
    .notification { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; color: white; display: none; z-index: 2000; font-weight: 500; background: #059669; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .notification.error { background: #dc2626; }

    /* MOBILE OVERRIDES */
    @media (max-width: 768px) {
      .brand-text { display: none; }
      nav { padding: 1rem; }
      nav ul { gap: 1rem; }
      .page-header { padding: 40px 1.5rem; }
      .page-header h1 { font-size: 2rem; }
      .products-section { padding: 30px 1rem; }
      .products-grid { grid-template-columns: 1fr; gap: 1.5rem; }
      .product-image { height: 220px; }
      .product-footer { flex-direction: column; align-items: stretch; gap: 12px; }
      .add-to-cart-btn { width: 100%; text-align: center; }
      .cart-section { padding: 1.5rem 1rem; margin: 0 10px 40px; }
    }
  </style>
</head>
<body>
<header>
  <nav>
    <div class="logo-container">
      <img src="LOGO.SVG" alt="Artisan Luthier Tools" class="logo">
      <span class="brand-text">Artisan Luthier Tools</span>
    </div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li>
        <a href="checkout.html" class="nav-cart-link" title="Go to Checkout">
          <i class="fa-solid fa-cart-shopping"></i>
          <span id="nav-cart-count" class="cart-badge">0</span>
        </a>
      </li>
    </ul>
  </nav>
</header>

<div class="page-header">
  <h1>Premium Luthier Tools</h1>
  <p>Handcrafted precision instruments for professional violin makers</p>
</div>

<div class="products-section">
  <div class="products-grid" id="products-list"></div>

  <div class="cart-section" id="cart-section" style="display:none;">
    <div class="cart-header">
      <h2>ðŸ›’ Your Cart</h2>
      <button class="clear-btn" onclick="clearCart()">Clear All</button>
    </div>
    <ul class="cart-list" id="cart-list"></ul>
    <div class="cart-total">
      <span>Total</span>
      <span id="cart-total">$0.00</span>
    </div>
    <button class="checkout-btn" onclick="checkout()">Proceed to Secure Checkout â†’</button>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
const API_BASE = "https://artisan-luthier-tool-website-1.onrender.com";
let csrfToken = null;

const products = [
  { id:"cello-neck-adjusting", name:"Cello Neck Setting Adjusting Tool", category:"Cello Tools", description:"Ensures optimal neck angle alignment for cellos.", price:420, image:"IMG_2757.PNG" },
  { id:"cello-neck-fixing", name:"Cello Neck Fixing Tool", category:"Cello Tools", description:"Securely holds the cello fingerboard and neck in place.", price:350, image:"IMG_3000PNG" },
  { id:"violin-neck-adjusting", name:"Violin/Viola Neck Setting Adjusting Tool", category:"Violin Tools", description:"Ensures optimal neck angle alignment.", price:370, image:"IMG_2900.png" },
  { id:"violin-neck-fixing", name:"Violin/Viola Neck Fixing Tool", category:"Violin Tools", description:"Securely holds the violin/viola neck in place.", price:285, image:"IMG_2800.png" },
  { id:"violin-fhole-jack", name:"Violin f-hole Leveling Jack", category:"Repair Tools", description:"Precisely align cracks on violin f-holes.", price:80, image:"ART_4.png" },
  { id:"cello-fhole-jack", name:"Cello f-hole Leveling Jack", category:"Repair Tools", description:"Precisely align cracks on cello f-holes.", price:100, image:"ART_5.png" },
  { id:"cello-fhole-clamp", name:"Cello f-hole Crack Clamp", category:"Clamps", description:"Stabilizes cello top cracks.", price:380, image:"ART_ 6.png" },
  { id:"violin-fhole-clamp", name:"Violin/Viola f-hole Crack Clamp", category:"Clamps", description:"Stabilizes violin/viola top cracks.", price:320, image:"ART_ 7.png" },
  { id:"violin-clamps-35", name:"35 pcs Violin/Viola Clamps", category:"Clamp Sets", description:"Protect varnish during gluing.", price:495, image:"ART_8.png" },
  { id:"cello-clamps-45", name:"45 pcs Cello Clamps", category:"Clamp Sets", description:"Professional-grade color-coded clamps.", price:690, image:"ART_9.png" }
];

/* ---------------- CSRF TOKEN LOADER (RELIABLE) ---------------- */
async function loadConfig(retries = 5, delay = 800) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(`${API_BASE}/config`, {
        credentials: 'include',
        cache: 'no-store'
      });
      if (!res.ok) throw new Error("Config fetch failed");
      const data = await res.json();
      csrfToken = data.csrfToken;
      return csrfToken;
    } catch (err) {
      await new Promise(r => setTimeout(r, delay));
    }
  }
  throw new Error("Could not get CSRF token");
}

/* ------------- FETCH WRAPPER WITH AUTO CSRF RETRY ------------- */
async function csrfFetch(url, options = {}, retry = true) {
  if (!csrfToken) await loadConfig();

  options.headers = {
    ...(options.headers || {}),
    'csrf-token': csrfToken
  };
  options.credentials = 'include';
  options.cache = 'no-store';

  const res = await fetch(url, options);
  let data = {};
  try { data = await res.json(); } catch {}

  // If CSRF failed, refresh token and retry ONCE
  if ((res.status === 403 || data.error?.includes("CSRF")) && retry) {
    console.warn("CSRF expired â€” refreshing token...");
    csrfToken = null;
    await loadConfig();
    return csrfFetch(url, options, false);
  }

  if (!res.ok || data.error) {
    throw new Error(data.error || "Request failed");
  }

  return data;
}

/* ---------------- PRODUCTS RENDER ---------------- */
function renderProducts() {
  const list = document.getElementById('products-list');
  list.innerHTML = products.map((p, i) => `
    <div class="product-card">
      <div class="product-image"><img src="${p.image}" alt="${p.name}"></div>
      <div class="product-info">
        <div class="product-category">${p.category}</div>
        <h3>${p.name}</h3>
        <p>${p.description}</p>
        <div class="product-footer">
          <div class="price">$${p.price}</div>
          <button onclick="addToCart('${p.id}', ${i})" id="btn-${i}" class="add-to-cart-btn">Add to Cart</button>
        </div>
      </div>
    </div>
  `).join('');
}

/* ---------------- CART ACTIONS ---------------- */
async function addToCart(productId, i) {
  const btn = document.getElementById(`btn-${i}`);
  btn.disabled = true;
  btn.textContent = "Adding...";
  try {
    await csrfFetch(`${API_BASE}/api/cart/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, qty: 1 })
    });
    showNotification("âœ“ Added to cart!");
    renderCart();
  } catch (err) {
    showNotification(err.message, true);
  }
  btn.disabled = false;
  btn.textContent = "Add to Cart";
}

async function removeFromCart(productId) {
  try {
    await csrfFetch(`${API_BASE}/api/cart/remove`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId })
    });
    renderCart();
  } catch (err) {
    showNotification(err.message, true);
  }
}

async function clearCart() {
  if (!confirm("Clear your cart?")) return;
  try {
    await csrfFetch(`${API_BASE}/api/cart/clear`, { method: 'POST' });
    renderCart();
  } catch (err) {
    showNotification(err.message, true);
  }
}

/* ---------------- RENDER CART ---------------- */
async function renderCart() {
  const res = await fetch(`${API_BASE}/api/cart`, {
    credentials: 'include',
    cache: 'no-store'
  });
  const data = await res.json();
  const cart = data.cart || [];
  const sec = document.getElementById('cart-section');
  const list = document.getElementById('cart-list');
  const totalDiv = document.getElementById('cart-total');
  const navBadge = document.getElementById('nav-cart-count');

  let totalQty = cart.reduce((s, i) => s + i.qty, 0);
  navBadge.textContent = totalQty;
  navBadge.style.display = totalQty ? 'block' : 'none';

  if (!cart.length) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';
  list.innerHTML = '';
  let total = 0;

  cart.forEach(item => {
    total += item.price * item.qty;
    const li = document.createElement('li');
    li.innerHTML = `
      <div class="cart-item-info">
        <span>${item.name}</span>
        <div style="display:flex; gap:10px; align-items:center;">
          <strong>Ã— ${item.qty}</strong>
          <button class="remove-btn" onclick="removeFromCart('${item.productId}')"> âˆ’ </button>
        </div>
      </div>
      <span>$${(item.price * item.qty).toFixed(2)}</span>
    `;
    list.appendChild(li);
  });
  totalDiv.textContent = `$${total.toFixed(2)}`;
}

/* ---------------- NOTIFICATIONS ---------------- */
function showNotification(msg, err=false){
  const n=document.getElementById('notification');
  n.textContent=msg;
  n.className='notification'+(err?' error':'');
  n.style.display='block';
  setTimeout(()=>n.style.display='none',3000);
}

function checkout(){ window.location.href="checkout.html"; }

/* ---------------- INIT ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  renderProducts();
  try { await loadConfig(); } catch { showNotification("Connection issue. Retry in a moment.", true); }
  renderCart();
});
</script>